{% extends "admin_base.html" %}
{% load static %}
{% block css_files %}
<style>
    .btn-close-white {
        filter: invert(1) brightness(2);
    }
    .error-message {
        color: red;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block wrapper %}
<div class="account-pages pt-2 pt-sm-5 pb-4 pb-sm-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xxl-4 col-lg-5">
                <div class="card">

                    <!-- Logo -->
                    <div class="card-header pt-4 pb-4 text-center bg-light">
                        <a href="#">
                            <span><img src="{% static "admin_page_app/images/logo.png" %}" alt="" height="45"></span>
                        </a>
                    </div>

                    <div class="card-body p-4">
                        <div class="text-center w-75 m-auto">
                            <h4 class="text-dark-50 text-center pb-0 fw-bold">Admin Sign In</h4>
                            <p class="text-muted mb-4">Enter your email address and password to access the admin panel.</p>
                        </div>

                        <!-- Add id to the form for the selector -->
                        <form id="adminLoginForm" method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="email_address" class="form-label">Email address</label>
                                <input class="form-control" type="email" id="email_address" name="email_address" required placeholder="Enter your email">
                                <div class="error-message" id="emailError" style="display: none;"></div>
                            </div>

                            <div class="mb-3">
                                <a href="{% url "account_app:reset_password_request" %}" class="text-muted float-end">
                                    <small>Forgot your password?</small>
                                </a>
                                <label for="password" class="form-label">Password</label>
                                <div class="input-group input-group-merge">
                                    <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password">
                                    <div class="input-group-text" data-password="false">
                                        <span class="password-eye"></span>
                                    </div>
                                </div>
                                <div class="error-message" id="passwordError" style="display: none;"></div>
                            </div>

                            <div class="mb-3">
                                <div class="error-message" id="generalError" style="display: none;"></div>
                            </div>

                            <div class="mb-3 mb-0 text-center">
                                <button class="btn btn-primary btn-with-spinner" type="submit" id="loginButton">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="button-text">Login</span>
                                </button>
                            </div>
                        </form>
                    </div> <!-- end card-body -->
                </div>
                <!-- end card -->
                {% if not admin_exists %}
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <p class="text-muted">Don't have an account? <a href="{% url "account_app:add_admin" %}" class="text-muted ms-1"><b>Sign Up</b></a></p>
                        </div> <!-- end col -->
                    </div>
                    <!-- end row -->
                {% endif %}

                

            </div> <!-- end col -->
        </div>
        <!-- end row -->
    </div>
    <!-- end container -->
</div>
<!-- end page -->
{% endblock wrapper %}

{% block footer %}
{% include "admin_page_partials/footer_alt.html" %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const loginButton = document.getElementById('loginButton');
        const emailInput = document.getElementById('email_address');
        const passwordInput = document.getElementById('password');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const generalError = document.getElementById('generalError');

        loginButton.addEventListener('click', function () {
            console.log("Login button clicked");
            let isValid = true;

            // Clear previous error messages
            emailError.style.display = 'none';
            passwordError.style.display = 'none';
            generalError.style.display = 'none';

            // Validate email
            if (!emailInput.value) {
                emailError.textContent = 'Email is required.';
                emailError.style.display = 'block';
                isValid = false;
            }

            // Validate password
            if (!passwordInput.value) {
                passwordError.textContent = 'Password is required.';
                passwordError.style.display = 'block';
                isValid = false;
            }

            // If validation fails, return
            if (!isValid) {
                console.log("Validation failed");
                return;
            }

            // Prevent multiple submissions
            if (loginButton.disabled) {
                return;
            }

            handleButtonLoadingState(loginButton);

            // Mark the button as disabled to prevent additional clicks
            loginButton.disabled = true;

            // Perform AJAX login
            const formData = new FormData();
            formData.append('email_address', emailInput.value);
            formData.append('password', passwordInput.value);

            fetch("{% url 'account_app:admin_login' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Check if the response is OK (status code 200)
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Response received:", data);
                if (data.success) {
                    // Redirect on success
                    window.location.href = data.redirect_url;
                } else {
                    // Reset button if there was an error
                    resetButtonLoadingState(loginButton);
                    loginButton.disabled = false; // Re-enable button for retry
                    // Show errors
                    generalError.textContent = data.error || 'An error occurred.';
                    generalError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                generalError.textContent = 'An unexpected error occurred.';
                generalError.style.display = 'block';
                // Reset button on catch error
                resetButtonLoadingState(loginButton);
                loginButton.disabled = false; // Re-enable button for retry
            });
        });

        // Function to handle button loading state
        function handleButtonLoadingState(button) {
            const originalText = button.textContent.trim();
            const loadingText = getLoadingText(originalText);

            // Show spinner and update button text
            const spinner = button.querySelector('.spinner-border');
            if (spinner) {
                spinner.classList.remove('d-none');
            }
            button.querySelector('.button-text').textContent = loadingText;
        }

        // Function to reset button loading state
        function resetButtonLoadingState(button) {
            const originalText = button.dataset.originalText;
            const spinner = button.querySelector('.spinner-border');

            if (spinner) {
                spinner.classList.add('d-none');
            }
            button.querySelector('.button-text').textContent = originalText;
        }

        // Function to derive the loading text based on the original text
        function getLoadingText(originalText) {
            if (originalText.endsWith('e')) {
                return `${originalText.slice(0, -1)}ing...`;
            } else if (originalText.endsWith('y')) {
                return `${originalText.slice(0, -1)}ying...`;
            }
            return `${originalText}ing...`;
        }

        // Store original text for the button
        loginButton.dataset.originalText = loginButton.textContent.trim();
    });
</script>

{% endblock %}


